<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POI Management - IndoorNav</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .map-container { position: relative; margin: 20px 0; border: 2px solid #ddd; border-radius: 5px; background: #f9f9f9; min-height: 400px; }
        .map-image { max-width: 100%; display: block; margin: 0 auto; }
        .poi-marker { position: absolute; width: 20px; height: 20px; background: #ff4444; border: 2px solid white; border-radius: 50%; cursor: pointer; transform: translate(-50%, -50%); }
        .poi-marker:hover { background: #ff6666; transform: translate(-50%, -50%) scale(1.2); }
        .controls { display: flex; gap: 20px; margin: 20px 0; }
        .control-section { flex: 1; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        .poi-list { margin: 20px 0; }
        .poi-item { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .poi-item h4 { margin: 0 0 10px 0; color: #333; }
        .poi-item p { margin: 5px 0; color: #666; }
        .delete-btn { background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .delete-btn:hover { background: #c82333; }
        .message { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .instructions { background: #e9ecef; padding: 15px; margin: 20px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è POI Management</h1>
        
        <div class="instructions">
            <h3>üìã Instructions:</h3>
            <ol>
                <li>Select your building and floor from the dropdowns</li>
                <li>Click on the map image to add POIs at specific locations</li>
                <li>Fill in POI details and click "Add POI"</li>
                <li>Manage existing POIs in the list below</li>
            </ol>
        </div>

        <div class="controls">
            <div class="control-section">
                <div class="form-group">
                    <label for="buildingSelect">Building:</label>
                    <select id="buildingSelect">
                        <option value="">Select a building...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="floorSelect">Floor:</label>
                    <select id="floorSelect">
                        <option value="">Select a floor...</option>
                    </select>
                </div>
            </div>
            
            <div class="control-section">
                <div class="form-group">
                    <label for="poiName">POI Name:</label>
                    <input type="text" id="poiName" placeholder="e.g., Conference Room A">
                </div>
                
                <div class="form-group">
                    <label for="poiCategory">Category:</label>
                    <select id="poiCategory">
                        <option value="room">Room</option>
                        <option value="elevator">Elevator</option>
                        <option value="stairs">Stairs</option>
                        <option value="restroom">Restroom</option>
                        <option value="entrance">Entrance</option>
                        <option value="exit">Exit</option>
                        <option value="emergency">Emergency Exit</option>
                        <option value="facility">Facility</option>
                        <option value="service">Service</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="poiDescription">Description:</label>
                    <textarea id="poiDescription" rows="3" placeholder="Optional description..."></textarea>
                </div>
                
                <button onclick="addPOI()">üìç Add POI</button>
            </div>
        </div>

        <div class="map-container" id="mapContainer">
            <img id="mapImage" class="map-image" style="display: none;">
            <div id="poiMarkers"></div>
        </div>

        <div id="message"></div>

        <div class="poi-list">
            <h3>üìç Existing POIs</h3>
            <div id="poiList">Select a building and floor to view POIs...</div>
        </div>
    </div>

    <script>
        // Dynamic API base
        const API_BASE = `${window.location.origin}/api/v1`;
        let buildings = [];
        let floors = [];
        let currentPOIs = [];
        let selectedCoordinates = null;
        let mapLoaded = false;

        // Load buildings
        async function loadBuildings() {
            try {
                const response = await fetch(`${API_BASE}/buildings`);
                buildings = await response.json();
                
                const buildingSelect = document.getElementById('buildingSelect');
                buildingSelect.innerHTML = '<option value="">Select a building...</option>';
                
                for (const building of buildings) {
                    buildingSelect.innerHTML += `<option value="${building.id}">${building.name}</option>`;
                }
            } catch (error) {
                showMessage('Error loading buildings: ' + error.message, 'error');
            }
        }

        // Load floors for a building
        async function loadFloors(buildingId) {
            try {
                const response = await fetch(`${API_BASE}/buildings/${buildingId}/floors`);
                floors = await response.json();
                
                const floorSelect = document.getElementById('floorSelect');
                floorSelect.innerHTML = '<option value="">Select a floor...</option>';
                
                for (const floor of floors) {
                    floorSelect.innerHTML += `<option value="${floor.id}">${floor.name} (Floor ${floor.floor_number})</option>`;
                }
            } catch (error) {
                showMessage('Error loading floors: ' + error.message, 'error');
            }
        }

        // Load map image
        async function loadMapImage(floorId) {
            const mapImage = document.getElementById('mapImage');
            const mapContainer = document.getElementById('mapContainer');
            
            try {
                // Get floor details to find the image
                const response = await fetch(`${API_BASE}/floors/${floorId}`);
                const floor = await response.json();
                
                if (floor.floor_plan_image) {
                    mapImage.src = floor.floor_plan_image;
                    mapImage.style.display = 'block';
                    mapLoaded = true;
                    showMessage('Map loaded! Click on the map to add POIs.', 'success');
                } else {
                    mapImage.style.display = 'none';
                    mapLoaded = false;
                    showMessage('No floor plan image found for this floor. Please upload one first.', 'error');
                }
            } catch (error) {
                showMessage('Error loading map: ' + error.message, 'error');
                mapImage.style.display = 'none';
                mapLoaded = false;
            }
        }

        // Handle map click
        document.getElementById('mapContainer').addEventListener('click', function(e) {
            if (!mapLoaded) {
                showMessage('Please load a map first!', 'error');
                return;
            }
            
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            selectedCoordinates = { x, y };
            
            // Add a temporary marker
            const marker = document.createElement('div');
            marker.className = 'poi-marker temp-marker';
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.style.background = '#28a745';
            
            const markersContainer = document.getElementById('poiMarkers');
            markersContainer.innerHTML = ''; // Clear previous temp markers
            markersContainer.appendChild(marker);
            
            showMessage(`POI location selected: (${Math.round(x)}, ${Math.round(y)})`, 'success');
        });

        // Add POI
        async function addPOI() {
            const buildingId = document.getElementById('buildingSelect').value;
            const floorId = document.getElementById('floorSelect').value;
            const name = document.getElementById('poiName').value;
            const category = document.getElementById('poiCategory').value;
            const description = document.getElementById('poiDescription').value;
            
            if (!buildingId || !floorId) {
                showMessage('Please select building and floor', 'error');
                return;
            }
            
            if (!name) {
                showMessage('Please enter POI name', 'error');
                return;
            }
            
            if (!selectedCoordinates) {
                showMessage('Please click on the map to select POI location', 'error');
                return;
            }
            
            const poiData = {
                name: name,
                category: category,
                poi_type: category,
                x_coordinate: selectedCoordinates.x,
                y_coordinate: selectedCoordinates.y,
                description: description || null,
                properties: {}
            };
            
            try {
                // For now, store POIs in localStorage (can be connected to API later)
                const floorPOIs = JSON.parse(localStorage.getItem(`pois_${floorId}`) || '[]');
                poiData.id = Date.now(); // Simple ID
                floorPOIs.push(poiData);
                localStorage.setItem(`pois_${floorId}`, JSON.stringify(floorPOIs));
                
                showMessage('POI added successfully!', 'success');
                
                // Clear form
                document.getElementById('poiName').value = '';
                document.getElementById('poiDescription').value = '';
                selectedCoordinates = null;
                document.getElementById('poiMarkers').innerHTML = '';
                
                // Refresh POI list
                loadPOIs(floorId);
                
            } catch (error) {
                showMessage('Error adding POI: ' + error.message, 'error');
            }
        }

        // Load POIs
        function loadPOIs(floorId) {
            const pois = JSON.parse(localStorage.getItem(`pois_${floorId}`) || '[]');
            currentPOIs = pois;
            
            const poiList = document.getElementById('poiList');
            
            if (pois.length === 0) {
                poiList.innerHTML = '<p>No POIs found for this floor.</p>';
                return;
            }
            
            let html = '';
            for (const poi of pois) {
                html += `
                    <div class="poi-item">
                        <h4>${poi.name}</h4>
                        <p><strong>Category:</strong> ${poi.category}</p>
                        <p><strong>Location:</strong> (${Math.round(poi.x_coordinate)}, ${Math.round(poi.y_coordinate)})</p>
                        ${poi.description ? `<p><strong>Description:</strong> ${poi.description}</p>` : ''}
                        <button class="delete-btn" onclick="deletePOI(${poi.id})">Delete</button>
                    </div>
                `;
            }
            
            poiList.innerHTML = html;
            
            // Display POI markers on map
            displayPOIMarkers(pois);
        }

        // Display POI markers on map
        function displayPOIMarkers(pois) {
            const markersContainer = document.getElementById('poiMarkers');
            
            // Clear existing markers (keep temp marker if exists)
            const tempMarker = markersContainer.querySelector('.temp-marker');
            markersContainer.innerHTML = '';
            if (tempMarker) {
                markersContainer.appendChild(tempMarker);
            }
            
            for (const poi of pois) {
                const marker = document.createElement('div');
                marker.className = 'poi-marker';
                marker.style.left = poi.x_coordinate + 'px';
                marker.style.top = poi.y_coordinate + 'px';
                marker.title = poi.name;
                markersContainer.appendChild(marker);
            }
        }

        // Delete POI
        function deletePOI(poiId) {
            const floorId = document.getElementById('floorSelect').value;
            const pois = JSON.parse(localStorage.getItem(`pois_${floorId}`) || '[]');
            const updatedPOIs = pois.filter(poi => poi.id !== poiId);
            localStorage.setItem(`pois_${floorId}`, JSON.stringify(updatedPOIs));
            
            showMessage('POI deleted successfully!', 'success');
            loadPOIs(floorId);
        }

        // Show message
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // Handle building selection change
        document.getElementById('buildingSelect').addEventListener('change', async function(e) {
            const buildingId = e.target.value;
            if (buildingId) {
                await loadFloors(buildingId);
            }
        });

        // Handle floor selection change
        document.getElementById('floorSelect').addEventListener('change', async function(e) {
            const floorId = e.target.value;
            if (floorId) {
                await loadMapImage(floorId);
                loadPOIs(floorId);
            } else {
                document.getElementById('mapImage').style.display = 'none';
                document.getElementById('poiMarkers').innerHTML = '';
                document.getElementById('poiList').innerHTML = 'Select a building and floor to view POIs...';
            }
        });

        // Load buildings on page load
        window.addEventListener('load', loadBuildings);
    </script>
</body>
</html>
